#!/bin/bash

function has-frame {
    emacsclient -n -e "(plusp (length (remove-if (lambda (x) \
                                                         (null (window-system x))) \
                                                 (frame-list))))"
}

function new-frame {
    emacsclient -c -n -a "" "$@"
}

function open-frame {
    emacsclient -n -a "" "$@"
}

function raise-frames {
    open-frame \
        -e "(mapcar #'raise-frame (remove-if (lambda (x) \
                                                 (null (window-system x))) \
                                             (frame-list))))"
}

function if-crashed-restart-emacs {
    function restart-emacs {
        notify-send "Emacs daemon crashed :(" "restarting"
        gksudo -m "Need your password to restart emacs daemon." rc-service emacs.lerax restart
    }

    [[ `rc-status --crashed` == *emacs.lerax* || ! `pgrep emacs` ]] && restart-emacs
}

if-crashed-restart-emacs

if [ `has-frame` == "t" ]; then
    open-frame "$@" 2> /dev/null || raise-frames 1> /dev/null

else
    new-frame "$@"
fi
